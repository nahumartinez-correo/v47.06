/****o* Pendientes de agrupación/OFB:post:CDStotalIngBr
* NOMBRE
*   OFB:post:CDStotalIngBr
* DESCRIPCION
*   Comportamiento del objeto (obligatorio)
* ENTRADAS
*   Parámetros de entrada de la rutina, sean argumentos o campos que tiene en cuenta
* SALIDAS
*   Campos modificados como resultado o returns cuyos valores sean no triviales
* IMPACTOS
*   Otros objetos que deberán ser analizados al modificar el objeto actual
* REFERENCIADO POR
*   Objetos que llaman al objeto documentado (obligatorio)
* DOCUMENTACION
*   Documentación relevante que deberá ser actualizada por la modificación de la rutina
* SOURCE
*/
#include "postcds.h"

SUB post:CDStotalIngBr(OPER)

   /********************************************************************************************************/
   /*                                                                                                      */
   /* [PAW - 06/01/99]      Esta rutina calcula el total del importe sin IVA de la tabla AuxIngBr.         */
   /*                                                                                                      */
   /* Parámetros:                                                                                          */
   /* - OPER: Operador que conincida con el de la tabla AuxIngBr.                                          */
   /*                                                                                                      */
   /* Salidas:                                                                                             */
   /* - siaf:importe2: Total del importe sin IVA de la tabla AuxIngBr.                                     */
   /*                                                                                                      */
   /********************************************************************************************************/

	/*Se agrega la selección por Nro. de Presupuesto - Gabriel Falciola*/
   local totalImp like siaf:importe2

   CDS SELECT FROM DSC:AuxIngBr_tbl BECOMES DSC:AuxIngBr_ctx \
              WHERE post:op_operator_id == OPER && PresNro == fld:PresNro
   //CDS FINDFIRST DSC:AuxIngBr_ctx LOCK
   CDS FINDFIRST DSC:AuxIngBr_ctx NOLOCK
   totalImp = 0
   DO
      if (cdsretval == -801) then
         break
      end if
      CDS EXTRACT DSC:AuxIngBr_ctx ALL
	  /*Dependiendo de la Categoría de IVA y la vinculación con respecto a la Provincia
	  acumulo los importes con o sin iva para calcular Ingresos Brutos - Gabriel Falciola*/
	  if (adt_TasCatIB_IBcImp == "S" && adt_prvta_vinc_ivaIB == "S")
	  		totalImp = totalImp + siaf:ImporteConIva
	  else
	  		totalImp = totalImp + siaf:ImporteSinIva
	  end if
   	  //CDS FINDNEXT DSC:AuxIngBr_ctx LOCK
   	  CDS FINDNEXT DSC:AuxIngBr_ctx NOLOCK
   LOOP
   CDS ENDSELECT DSC:AuxIngBr_ctx
   /*Si sumo con el IVa incluído, debo sumar también los importes de
	Acrecentamientos y Percepciones*/
   if (adt_TasCatIB_IBcImp == "S" && adt_prvta_vinc_ivaIB == "S")
   		totalImp = totalImp + ImpTotAcrePerc
   		totalImp = totalImp + ImpTotRG3337
   end if
   siaf:importe2 = totalImp
END SUB

/*******/
