/****o* Pendientes de agrupación/OFB:giros:SVAL70180
* NOMBRE
*   OFB:giros:SVAL70180
* DESCRIPCION
*   Comportamiento del objeto (obligatorio)
* ENTRADAS
*   Parámetros de entrada de la rutina, sean argumentos o campos que tiene en cuenta
* SALIDAS
*   Campos modificados como resultado o returns cuyos valores sean no triviales
* IMPACTOS
*   Otros objetos que deberán ser analizados al modificar el objeto actual
* REFERENCIADO POR
*   Objetos que llaman al objeto documentado (obligatorio)
* DOCUMENTACION
*   Documentación relevante que deberá ser actualizada por la modificación de la rutina
* SOURCE
*/
#include "girossval.h"

sub giros:SVAL70180
	//
    LOCAL tran_status_aux LIKE hcomm:tran_status
    
    local enSesion_aux like post:enSesion
    
    if (post:estado_presu == 1 || post:estado_presu == 2 || post:estado_presu == 3) then
	popup giros:SCRNemis2,PRESemis2 PCOLemis2
	if (lastkey == RT_ESC) then
	    return (-2)
	end if

	popup giros:SCRNemis1,PRESemis1 PCOLemis1
	if (lastkey == RT_ESC) then
	    return (-2)
	end if

	call MISCenvio_post_tel
 	if (retval < 0) then
	    return -2
	else
	    IF (testflag(flags_back,vencido)) then
		//Si el giro esta vencido no se puede hacer la tx
		MSGBOX "DEBE REALIZAR LA REVALIDA PRIMERO",0x00,"Error"
		ungetkey RT_ESC
		return (-2)
	    ELSE
		msgbox "¿Desea confirmar la transacción?",OFB_YESNO,"Atención"
		if (retval == 7) then
		    ungetkey RT_ESC
		    return (-2)
		end if
	    END IF			
	end if
	
	/* Si la transaccion se cobra por porcentaje, esta SVAL deja la formula en el 
	   campo formuCalc para ser impreso en la factura*/
	call SVALgralFormCalGiro		

    end if
    //
    consulta = 0
    siaf:siaf_status = HOST_ACCEPTED
    //
    
    //Reingenieria
    //if (post:estado_presu == 1 || post:estado_presu == 4) then
    if (post:estado_presu < 4) then	
	if (siaf:codigo_siaf == 70173 || siaf:codigo_siaf == 70181) then
	    call MISCsupervision
	    if (retval < 0) then
		return (-2)
	    end if
	end if
    end if
	
    if (post:estado_presu == 1 || post:estado_presu == 4) then
	
        //
    	
    	/* SE SACA LA REVALIDA AUTOMATICA
    	
    	if (testflag(flags_back,vencido)) then
    	    setflag flags_back,es_revalida
    	    siaf:codigo_siaf_aux = siaf:codigo_siaf
    	    siaf:codigo_siaf = siaf:codigo_rev
    	    call giros:PRESgral_giro
			//
    	    call giros:MISCrevalida_autom(siaf:codigo_siaf_aux,siaf:codigo_siaf)
	end if*/
	   	
	//
	if (siaf:siaf_status == HOST_ACCEPTED) then
	    //
	    clave_hdr_giros  = 0
	    giros:codigo_procesamiento = siaf:codigo_proc
	    giros:hora_viaje = common:time_of_day
	    giros:dia_viaje  = common:system_date
	    Call post:CDSobtiene_secuen("STAN")
	    //
	    post:ImporteConIva = imp_servicio_fld
	    post:ImporteSinIva = imp_serv_siniva
	    //
	    siaf:importe = post:ImporteConIva
	    //

	    // parece que hay veces que el campo post:enSesion queda sucio
	    // y esto hace que la tx quede journalizado con tlr:jnl_status = 002 (MEMO)
	    enSesion_aux = post:enSesion
	    clearfield post:enSesion

	    post:ctrol_ult_tt = "S"

	    if (post:estado_presu == 1) then
	    	//cgw: En teclas rapidas, arma PresuDet para las sesiones con posventas de giros.
	    	Call post:MISCgrabo_PresuDet_g
	    end if

	    call tlr:JNLtran
	    post:ctrol_ult_tt = ""

	    post:enSesion = enSesion_aux
	    //
	    IF (hcomm:tran_status != HOST_ACCEPTED) then
		call MISCanulo_transac("ANULA_REVALIDA")
	    ELSE
		//leyenda = "CAMBIO OFICINA PAGADORA"
		//call giros:MISCimpre_comprob	
		/*Se imprime despues de generar la PresuDet, por eso se guarda el tran_status*/
		tran_status_aux = hcomm:tran_status
				
		/* Llamo a la MISCTotalTransac solo si la transacción fue ACEPTADA. Hernán 21/12/2000*/
		CALL post:MISCTotalTransac(siaf:codigo_siaf)
	    END IF
			//
	else
	    call MISCanulo_transac("NONE")
	end if
    	/*limpio campos para que la JNLtran no ejecutre nada dos veces*/
    	CLEARFIELD drv:INDhcomm_rtn
    	CLEARFIELD drv:INDspc_rtn[1]
    	CLEARFIELD drv:INDcur_tran
    	CLEARFIELD drv:INDjnl_rtn
    	CLEARFIELD drv:INDspc_rtn[0]
		//
    end if
    //
    post:ImporteConIva = imp_servicio_fld + imp_revalida_fld
    post:ImporteSinIva = imp_serv_siniva  + imp_sin_iva_rev
    //
    siaf:importe = post:ImporteConIva
    //
    siaf:ImporteConIva = post:ImporteConIva
    siaf:ImporteSinIva = post:ImporteSinIva
    //
    if (post:estado_presu == 2 || post:estado_presu == 3) then
	post:PreDForFis = post:adt_serv_formfiscal
	call post:MISCAcumTotalesSes /* llamo rutina de calculo de Ingresos Brutos */
    end if
    //
    CALL post:MISCGrabaDetalleTrn
    CALL post:MISCgrabo_sinsesion

    if (post:estado_presu == 4 || post:estado_presu == 1) then
	IF (siaf:siaf_status == HOST_ACCEPTED) then
	    IF (tran_status_aux == HOST_ACCEPTED) then
		leyenda = "CAMBIO OFICINA PAGADORA"
		call giros:MISCimpre_comprob	
	    END IF
	END IF
    end if

end sub

/*******/
