/****o* SiMon/OFB:tes:PRESentrada_ATM
* NOMBRE
*   OFB:tes:PRESentrada_ATM
* DESCRIPCION
*   Rutina PRES de la transaccion de Entrada de Efectivo desde ATM
* ENTRADAS
*   Parámetros de entrada de la rutina, sean argumentos o campos que tiene en cuenta
* SALIDAS
*   Campos modificados como resultado o returns cuyos valores sean no triviales
* IMPACTOS
*   Otros objetos que deberán ser analizados al modificar el objeto actual
* REFERENCIADO POR
*   tes:TRANentrada_ATM
* DOCUMENTACION
*   Documentación relevante que deberá ser actualizada por la modificación de la rutina
* SOURCE
*/
#include "tespres.h"

SUB tes:PRESentrada_ATM

	IF (!(testflag(tlr:tran_flags,correction))) THEN
	
		//si el tesoro no esta abierto no puede operar
		CDS SELECT from DSC:tes:tesoro_table BECOMES DSC:tes:tesoro_context WHERE \
			tes:tes_suc_id == op:op_branch_id && \
			tes:tes_fecha == common:system_date
		CDS FINDFIRST DSC:tes:tesoro_context NOLOCK
		if (cdsretval != 0)
			/* El tesoro no esta abierto este dia */
			MSGBOX "TESORO CERRADO. No puede realizar Entrada de Efectivo de ATM",0x00,"Error"
			return (-2)
		end if
		
	
	    IF (drv:dt_app != 2)
    	    /*Si estoy accediendo por el PDM Tesoro tengo
        	que inicializar el contexto del journal*/
	        call ofb:tlr:JNLinitialize
    	    if (tlr:bus_date == "") then
		    	// si sale con la fecha vacia le pongo la de hoy para que no de
			    // error al journalizar
			    tlr:bus_date = common:system_date
    	    end if
		END IF	

	end if


	tes:es_tesoro = "S"
	tes:viaja_nro_tesoro = "S"
	siaf:moneda = "00"
	
	clearfield post:track_trace
	clearfield tes:sucursal
	
	
    siaf:codigo_siaf = 6870 
	CLEARFIELD post:importe_origen
	REFRESH post:importe_origen
	 clearfield siaf:importe
    CALL siaf:PRESfecha_hora
    if (retval < 0) then
    	PDM CHECKITEM drv:tesoro,20,MOA_UNCHECKED    	   	   	
    	; La siguiente línea se hace para que vuelva a la aplicación anterior
		; ya que el drv:driver hace que regrese al desktop (PS9438) *** MDG 
		ungetkey RT_ESC
		; La siguiente línea es para solo habilite el botón F2,F3,F4,F5 según 
		; donde esté parado a fin de que el resto de los botones estén deshabilitados.
		call tes:DT_app_exit
        return (0)
    end if
END SUB

/*******/
